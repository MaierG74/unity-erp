# Timekeeping Frontend – Living Document

This document describes the current frontend implementation of Time & Attendance in Unity ERP. It is meant to be a living reference for future changes. It focuses on the client-side flows, key files, query contracts, and UX patterns. See `docs/domains/timekeeping/time-attendance-working.md` and `docs/plans/time-attendance-plan.md` for deeper architecture and backend logic.

## High-level user flows

- Daily attendance page shows staff list for a selected date with hours and events.
- Admins can:
  - Add manual clock events (clock in/out, break start/end)
  - Edit or delete existing events
  - Mass apply clock in/out at a chosen time
  - Process clock events → regenerate work/break segments → regenerate daily summaries
  - Toggle present/absent and adjust start/end/breaks in legacy view

## Key UI entry points

- `app/staff/page.tsx` – main staff attendance page wrapper
- `app/staff/hours/page.tsx` – hours report page (summary view)

## Core React components

- `components/features/staff/DailyAttendanceGrid.tsx`
  - The main container for the daily attendance experience.
  - Responsibilities:
    - Date picker and view mode (Legacy vs Timeline)
    - Loads staff, clock events, segments, daily summaries (React Query)
    - Mass actions dialog and processing buttons
    - Save attendance in legacy mode (`staff_hours`) and inline edits
    - Targeted cache refresh for a single staff member after edits
  - Important callbacks:
    - `handleManualClockEvent(staffId, eventType, time, breakType, notes)`
    - `processClockEventsData(staffId?)` → calls processing utility and refreshes caches
    - `refreshStaffAttendanceCaches(dateStr, staffId)` → merges staff-scoped query data back into global caches
  - React Query keys used:
    - `['staff','active']` – active staff list
    - `['time_clock_events', date]` – all events for date
    - `['time_segments', date]` – all segments for date
    - `['time_daily_summary_all', date]` – summaries list for date
    - `['time_daily_summary', date, staffId]` – per-staff summary (used by timeline rows)

- `components/features/staff/AttendanceTimeline.tsx`
  - Per-staff timeline, used in “Timeline View” for each staff row
  - Displays status, hours summary, clock events list, and computed segments
  - Provides add/edit/delete manual events; triggers staff-scoped processing
  - Shows “Missing clock-out” hint if last event is a `clock_in`

- `components/features/staff/MassClockActionDialog.tsx`
  - UI to apply a clock in/out time to multiple staff at once for the selected date
  - On confirm calls `handleMassApply` in grid, which writes events and refreshes caches

- `components/features/staff/DailyHoursDetailDialog.tsx`
  - Drill-in detail dialog (hours/segments) used from reports when needed

- `components/features/staff/StaffReports.tsx`
  - Reporting components for hours and summaries

## APIs used from frontend

- `app/api/process-clock-events/route.ts` (POST)
  - Body: `{ date: 'YYYY-MM-DD', staffId?: number }`
  - Action: process events → segments → summary (optionally for one staff)

- `app/api/process-all/route.ts` (GET)
  - Action: process all dates (maintenance)

- Direct Supabase queries from the client:
  - Tables read: `staff`, `time_clock_events`, `time_segments`, `time_daily_summary`, `public_holidays`, `staff_hours`
  - Writes:
    - `time_clock_events` (manual add/edit/delete) – via utils
    - `time_segments`/`time_daily_summary` – indirectly generated by processors
    - `staff_hours` – legacy save path in grid

## Client utilities and types

- `lib/utils/attendance.ts`
  - `processClockEventsIntoSegments(dateStr, staffId?)`
    - Reads events for SAST day window
    - Clears existing `time_segments` for target scope
    - Pairs `clock_in`/`clock_out`, handles breaks, overnight splits, open segments
    - Calls `generateDailySummary` for the processed staff
  - `generateDailySummary(dateStr, staffId?)`
    - Aggregates `time_segments` into `time_daily_summary`
    - Computes totals (work/break), first/last, regular vs OT vs DT
    - Writes/updates summary row and wage cents (rate lookup from `staff`)
  - `addManualClockEvent(staffId, eventType, dateStr, time, breakType, notes)`
    - Inserts a single event via RPC `add_manual_clock_event_v2` with fallback
    - Creates the matching segment (for clock_out/break_end)
    - Updates the day’s summary

- `lib/types/attendance.ts`
  - Type definitions: `ClockEvent`, `TimeSegment`, `DailySummary`, etc.

- `lib/utils/timezone.ts`
  - Helpers for SAST day boundaries and timestamp creation

## Data flow (frontend perspective)

1) Load date → React Query fetches:
   - staff list, events, segments, daily summaries, public holidays
2) User actions:
   - Add/edit/delete event → `addManualClockEvent` or direct Supabase update → call `processClockEventsData(staffId)`
   - Mass apply → loop `addManualClockEvent` for each staff → per-staff cache refresh
   - Process all → `processClockEventsData()` without staffId → invalidate global queries
3) Cache refresh patterns:
   - Prefer targeted refresh using `refreshStaffAttendanceCaches(dateStr, staffId)` to avoid global re-render storms
   - Fallback to `queryClient.invalidateQueries` when errors occur

## UX rules and calculations

- Daily hours shown in timeline prefer `time_daily_summary` when available to reflect unpaid tea-break deductions and Sunday double-time. If summary isn’t available, hours are calculated from segments.
- Business rules summarized:
  - Mon–Thu: auto 30 min tea deduction
  - Fri: no deduction
  - Sun: all hours double-time
  - Regular vs OT: first 9 hours regular, remainder OT (1.5×)

See additional detail in:
- `docs/domains/timekeeping/time-attendance-working.md` – schema and performance notes
- `docs/plans/time-attendance-plan.md` – planned DB trigger to centralize deductions
- `docs/overview/master-plan.md` – global rules recap

## Pages and navigation

- `app/staff/page.tsx`
  - Renders `DailyAttendanceGrid`
  - Keeps date state and provides the entry to timeline/legacy views

- `app/staff/hours/page.tsx`
  - Uses `time_daily_summary` for per-day reports and payroll exports (when applicable)

## Known limitations / risks

- Realtime subscriptions for events/segments are currently disabled in `DailyAttendanceGrid` to reduce re-renders; we rely on explicit processing and targeted cache refresh.
- Legacy `staff_hours` write path exists for manual overrides; ensure consistency with `time_daily_summary` used elsewhere.
- Overnight shift handling splits at local midnight (UTC+2) and writes two segments.

## Quick dev references

- To process one staff for selected date from UI: Timeline row → circular refresh button.
- To process all staff for a date: “Process All Staff” button in `DailyAttendanceGrid`.
- To fix segments from scripts: see `scripts/processAllClockEvents.ts` and API `GET /api/process-all`.

## Future enhancements

- Move 30-minute deduction into a DB trigger (remove client subtraction when live).
- Add weekly summary view and payroll-ready exports directly in the frontend.
- Re-enable realtime sync when performance allows, scoped to per-staff channels.
- Consolidate legacy `staff_hours` with `time_daily_summary` write path or add reconciliation.

