# Airtable ⇄ Supabase Data Mapping Reference

This reference captures how each Airtable table maps into Unity ERP (Supabase). Use it when auditing migrations, wiring MCP queries, or adding new fields so our schema stays aligned.

> ✅ **Scope:** Components, Products, Orders, and Staff—the four Airtable sources we currently sync.
> ❗ **Rule:** Update this document whenever Airtable schemas or Supabase tables gain/lose columns.

---

## Components

| Airtable Field | Type | Supabase Target | Notes |
| --- | --- | --- | --- |
| `Product` | Long text | `components.description` | Free-form description of the component/material. |
| `Internal Code` (if present) | Single line text | `components.internal_code` | Autogenerated when blank using `COMP-########`; must be unique. |
| `Supplier` | Linked record → Suppliers table | `suppliercomponents.supplier_id` | Script resolves supplier name → ID (creates supplier when missing). |
| `Supplier Price` | Currency | `suppliercomponents.price` | Stored as numeric(10,2); script enforces ≥ 0. |
| `Code` | Single line text | `suppliercomponents.supplier_code` | Supplier-facing SKU. Required for each supplier-component row. |
| `Category` | Single select | `component_categories.categoryname` + FK to `components.category_id` | Categories are upserted by name before assignment. |
| `Unit` | Single select | `unitsofmeasure.unit_code` + FK to `components.unit_id` | Units are upserted by code; defaults to `ea` if missing. |
| `Image` | Attachment | `components.image_url` | Files uploaded to Supabase Storage `QButton/products/{internal_code}/...`. |
| `Notes / Extra fields` | (varies) | `components.metadata` (JSONB, optional future) | Track new Airtable columns here before committing schema changes. |

---

## Products

| Airtable Field | Type | Supabase Target | Notes |
| --- | --- | --- | --- |
| `Code` | Single line text | `products.internal_code` | Unique SKU for finished good. |
| `Name` | Single line text | `products.name` | Required, shown in quotes/orders. |
| `Notes` | Long text | `products.description` | Markdown supported in UI. |
| `Catagory` *(spelling from Airtable)* | Multi-select | `product_categories` + `product_category_assignments` | Multi-select spelled incorrectly in base; scripts preserve original spelling when fetching. |
| `Photos` | Attachment | Supabase Storage `QButton/products/{code}/` + `product_images` table (if enabled) | When `--force-images` flag used, re-uploads even if URLs already exist. |
| `Reference Docs` (optional) | Attachment | `quote_attachments` or `product_documents` (future) | Record location in `products.metadata`. |

---

## Orders

| Airtable Field | Type | Supabase Target | Notes |
| --- | --- | --- | --- |
| `Order Number` | Text | `orders.order_number` | Required and unique. Used as folder name in storage. |
| `Customer` | Linked record or text | `customers.name` + `orders.customer_id` | Script looks up by name (case-insensitive). When `--auto-create-customer` is set, inserts new customer rows. |
| `Created` | Date | `orders.order_date` / `orders.created_at` | Defaults to Airtable timestamp; fallback to script run time. |
| `Status` (optional view filter) | Single select | `order_statuses.status_name` + `orders.status_id` | Upsert status names before assigning; defaults to "Pending" if blank. |
| `Attach Order` | Attachment | `order_attachments.file_url` + Supabase Storage `QButton/orders/{order_number}/...` | Script stores file name + signed URL. |
| `Delivery Date` | Date | `orders.delivery_date` | Converted to ISO date. |
| `Amount` | Currency | `orders.total_amount` | Optional; defaults to `NULL` if absent. |

---

## Staff

| Airtable Field | Type | Supabase Target | Notes |
| --- | --- | --- | --- |
| `FirstName` | Text | `staff.first_name` | Required. |
| `LastName` | Text | `staff.last_name` | Optional. |
| `Job Description` | Text | `staff.job_description` | |
| `Phone Number` | Text | `staff.phone` | Normalized to E.164 when possible. |
| `Email` | Text | `staff.email` (future) / stored in metadata currently | Add column if we need native email field. |
| `Current Staff` | Checkbox | `staff.current_staff` + `staff.is_active` | Checkbox true sets both fields to `true`. |
| `Rate` | Currency | `staff.hourly_rate` | Defaults to `0`. |
| `Weekly Hours` | Number | `staff.weekly_hours` | Optional; defaults to `40`. |
| `ID Document` | Attachment | `staff.id_document_urls` (text[]) + Storage `QButton/staff/{airtable_id}/id/` | Array of URLs; UI shows inline previews. |
| `Bank Account` | Attachment | `staff.bank_account_image_urls` (text[]) + Storage `QButton/staff/{airtable_id}/bank/` | Same pattern as ID docs. |
| `Notes / Team Headers` | Text | filtered out | Script skips records tagged as headers. |
| `Airtable Record ID` | System | `staff.airtable_id` | Stored for dedup + reprocessing. |

---

## Attachment Handling

1. Download each Airtable attachment via its temporary URL.
2. Upload to Supabase Storage bucket `QButton` (or environment-specific bucket) under an entity-specific path.
3. Record the public/storage URL in the appropriate Supabase table/column.
4. When rerunning migrations, skip uploads unless `--force-images` or `--force-attachments` is provided to the script.

---

## Linked Record Resolution

- Supplier links, category links, and product category assignments rely on the Airtable record name, not the record ID. This keeps CSV exports workable but requires clean names.
- If multiple Airtable records share the same display name, scripts log a warning and skip the row. Use Airtable filters to detect duplicates before running a migration.

---

## Adding New Fields

1. Add the column to Supabase via migration (SQL file + Supabase dashboard script).
2. Update the corresponding Python migration script to populate it.
3. Document the mapping in this file (new table row) and link any helper docs.
4. Re-run migrations for the affected dataset (full or incremental) and verify using MCP queries.

---

_Last updated: 2025-11-25_
